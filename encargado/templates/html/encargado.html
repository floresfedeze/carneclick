{% extends "base_encargado.html" %}
{% load static %}

{% block head %}
<title> Encargado </title>
{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Panel del encargado</h2>
            <small class="text-muted">Resumen operativo y accesos rápidos</small>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary">Reportes</button>
            <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'encargado:reporte_consolidado' %}">Consolidado</a></li>
                <li><a class="dropdown-item" href="{% url 'encargado:reporte_stock' %}">Stock</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'encargado:reporte_vencimientos' %}">Por vencer</a></li>
            </ul>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Pedidos pendientes</div><div class="display-6">{{ pendientes_clientes }}</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Pedidos activos</div><div class="display-6">{{ pedidos_activos }}</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Viajes activos</div><div class="display-6">{{ viajes_activos }}</div></div></div></div>
        <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Stock disponible (kg)</div><div class="display-6">{{ stock_kg|floatformat:1 }}</div></div></div></div>
    </div>

    <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Productos por vencer ({{ vencen_en }} días): <span class="badge bg-danger">{{ por_vencer_count }}</span></span>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'encargado:reporte_vencimientos' %}?dias={{ vencen_en }}">Ver todos</a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead><tr><th>#</th><th>Corte</th><th>Kilos</th><th>Frigorífico</th><th>Vence</th></tr></thead>
                <tbody>
                    {% for p, v in por_vencer_top %}
                        <tr>
                            <td>{{ p.id }}</td>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.kilos|floatformat:1 }} kg</td>
                            <td>{{ p.frigorificop }}</td>
                            <td>{{ v|date:"d/m/Y H:i" }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="5" class="text-center py-3">Sin productos por vencer en {{ vencen_en }} días</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Últimos pedidos preparados</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0"><thead><tr><th>#</th><th>Comercio</th><th>Fecha</th></tr></thead>
                    <tbody>
                        {% for p in ult_pedidos_preparados %}
                        <tr><td>{{ p.id }}</td><td>{{ p.cliente.comercio.nombre }}</td><td>{{ p.creado_en|date:"d/m/Y H:i" }}</td></tr>
                        {% empty %}<tr><td colspan="3" class="text-center py-3">Sin registros</td></tr>{% endfor %}
                    </tbody></table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Últimos pedidos entregados</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0"><thead><tr><th>#</th><th>Comercio</th><th>Fecha</th></tr></thead>
                    <tbody>
                        {% for p in ult_pedidos_entregados %}
                        <tr><td>{{ p.id }}</td><td>{{ p.cliente.comercio.nombre }}</td><td>{{ p.creado_en|date:"d/m/Y H:i" }}</td></tr>
                        {% empty %}<tr><td colspan="3" class="text-center py-3">Sin registros</td></tr>{% endfor %}
                    </tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <div class="row g-3 mt-3">
                    <div class="col-lg-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header">Pedidos por estado</div>
                                    <div class="card-body">
                                            <div id="homePedidosEstado" style="height:260px;"></div>
                                    </div>
                            </div>
                    </div>
                    <div class="col-lg-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header">Stock por corte (kg)</div>
                                    <div class="card-body">
                                            <div id="homeStockCortes" style="height:260px;"></div>
                                    </div>
                            </div>
                    </div>
            </div>

            <div class="row g-3 mt-3">
                    <div class="col-lg-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header">Ocupación por cámara (productos)</div>
                                    <div class="card-body">
                                            <div id="homeCamaraOcupacion" style="height:260px;"></div>
                                    </div>
                            </div>
                    </div>
                    <div class="col-lg-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header">Vencimientos por fecha</div>
                                    <div class="card-body">
                                            <div id="homeVencimientos" style="height:260px;"></div>
                                    </div>
                            </div>
                    </div>
            </div>

</div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
    // Pedidos por estado (pie)
    (function(){
        const labels = [
            {% for e in pedidos_por_estado %}"{{ e.estado__estado|capfirst }}"{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const data = [
            {% for e in pedidos_por_estado %}{{ e.cant }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const el = document.getElementById('homePedidosEstado');
        if (el && labels.length) {
            echarts.init(el).setOption({
                tooltip: { trigger: 'item' },
                legend: { bottom: 0 },
                series: [{
                    type: 'pie', radius: ['40%','70%'],
                    itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
                    data: labels.map((l,i)=>({ name: l, value: data[i] }))
                }]
            });
        }
    })();

    // Stock por corte (bar)
    (function(){
        const labels = [
            {% for s in stock_por_corte %}"{{ s.nombre__nombre|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const data = [
            {% for s in stock_por_corte %}{{ s.kilos|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const el = document.getElementById('homeStockCortes');
        if (el && labels.length) {
            echarts.init(el).setOption({
                tooltip: {},
                xAxis: { type: 'category', data: labels },
                yAxis: { type: 'value', name: 'kg' },
                series: [{ type: 'bar', data, itemStyle: { color: '#0d6efd' } }]
            });
        }
    })();

    // Ocupación por cámara (stacked productos)
    (function(){
        const names = [
            {% for f in home_frigo_resumen %}"{{ f.nombre|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const ocupados = [
            {% for f in home_frigo_resumen %}{{ f.productos }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const disponibles = [
            {% for f in home_frigo_resumen %}{{ f.restante }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const el = document.getElementById('homeCamaraOcupacion');
        if (el && names.length) {
            echarts.init(el).setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: ['Ocupado', 'Disponible'] },
                xAxis: { type: 'category', data: names },
                yAxis: { type: 'value', name: 'Productos' },
                series: [
                    { name: 'Ocupado', type: 'bar', stack: 't', data: ocupados, itemStyle: { color: '#198754' } },
                    { name: 'Disponible', type: 'bar', stack: 't', data: disponibles, itemStyle: { color: '#6c757d' } }
                ]
            });
        }
    })();

    // Vencimientos por fecha (line)
    (function(){
        const labels = [
            {% for v in venc_fechas %}"{{ v.fecha|date:'d/m/Y' }}"{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const data = [
            {% for v in venc_fechas %}{{ v.cant }}{% if not forloop.last %}, {% endif %}{% endfor %}
        ];
        const el = document.getElementById('homeVencimientos');
        if (el && labels.length) {
            echarts.init(el).setOption({
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: labels },
                yAxis: { type: 'value', name: 'Cant.' },
                series: [{ type: 'line', smooth: true, data, lineStyle: { color: '#dc3545' }, areaStyle: { color: 'rgba(220,53,69,0.2)' } }]
            });
        }
    })();
    </script>
{% endblock %}