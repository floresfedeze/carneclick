{% extends "base_encargado.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
	<!-- Encabezado -->
	<div class="d-flex align-items-center mb-3">
		<h2 class="me-3 mb-0">Nuevo Pedido</h2>
		<span class="badge text-bg-secondary">#{{ pedido.id }}</span>
	</div>

	<!-- Info Cliente y Sucursales -->
	<form id="finalizar-form" method="post" action="{% url 'encargado:finalizar_pedido' pedido.id %}" class="card shadow-sm mb-4">
		<div class="card-header bg-primary text-white">
			<strong>Datos del Cliente</strong>
		</div>
		<div class="card-body">
			{% csrf_token %}
			<div class="row g-3">
				<div class="col-md-4">
					<div class="small text-muted">Cliente</div>
					<div class="fw-semibold">{{ cliente.nombre }} {{ cliente.apellido }}</div>
					<div class="text-muted">DNI: {{ cliente.dni }}</div>
				</div>
				<div class="col-md-4">
					<div class="small text-muted">Sucursal destino</div>
					<div class="fw-semibold">{{ cliente.comercio.nombre }}</div>
					<div class="text-muted">Dirección: {{ cliente.comercio.direccion }}</div>
				</div>
				<div class="col-md-4">
					<div class="small text-muted mb-1">Sucursal origen</div>
					{{ pedido_form.comercio_origen }}
				</div>
			</div>
			<div class="row mt-3">
				<div class="col-md-12">
					<div class="small text-muted mb-1">Observaciones</div>
					{{ pedido_form.observaciones }}
				</div>
			</div>
			<div class="form-text mt-1">La sucursal de origen y las observaciones se guardan al finalizar el pedido.</div>
		</div>
	</form>

	<!-- Agregar productos por ID -->
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-info text-white">
			<strong>Agregar productos por Codigo</strong>
		</div>
		<div class="card-body">
			<form method="post" action="{% url 'encargado:agregar_producto_por_id' pedido.id %}" class="row g-3 align-items-end">
				{% csrf_token %}
				<div class="col-md-4">
					<label for="id_producto_id" class="form-label">ID del producto</label>
					<input type="number" name="producto_id" id="id_producto_id" class="form-control" placeholder="Ej: 101" required>
				</div>
				<div class="col-md-3">
					<button type="submit" class="btn btn-success w-100">Agregar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Listado de productos del pedido -->
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-success text-white">
			<strong>Productos del pedido</strong>
		</div>
		<div class="card-body">
			{% if pedido.detallepedido_set.all %}
			<div class="table-responsive">
				<table class="table table-striped table-hover align-middle">
					<thead class="table-dark">
						<tr>
							<th style="width: 100px">Código</th>
							<th>Descripción</th>
							<th style="width: 120px">Kilos</th>
							<th>Frigorífico</th>
							<th style="width: 140px">Acciones</th>
						</tr>
					</thead>
					<tbody>
						{% for item in pedido.detallepedido_set.all %}
						<tr>
							<td>#{{ item.producto_id.id }}</td>
							<td>{{ item.producto_id.nombre }}</td>
							<td>{{ item.producto_id.kilos }} kg</td>
							<td>{{ item.producto_id.frigorificop.nombre }}</td>
							<td>
								<a href="{% url 'encargado:eliminar_producto_pedido' item.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Eliminar producto del pedido?')">Eliminar</a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			{% else %}
			<div class="alert alert-warning mb-0">Todavía no agregaste productos a este pedido.</div>
			{% endif %}
		</div>
	</div>

	<!-- Acciones -->
	<div class="d-flex justify-content-between">
		<a href="{% url 'encargado:pedidos_pendientes' %}" class="btn btn-outline-secondary">Volver</a>
		<div class="d-flex gap-2">
			{% if pedido.detallepedido_set.all %}
			<a href="{% url 'encargado:boleta_pedido' pedido.id %}" class="btn btn-primary">Boleta PDF</a>
			{% else %}
			<button class="btn btn-primary" disabled title="Agrega productos para generar boleta">Boleta PDF</button>
			{% endif %}
			<a href="{% url 'encargado:cancelar_pedido' pedido.id %}" class="btn btn-outline-danger" onclick="return confirm('Cancelar el pedido? Se eliminará el pedido pendiente.')">Cancelar</a>
			{% if pedido.detallepedido_set.all %}
			<button type="submit" form="finalizar-form" class="btn btn-success">Finalizar</button>
			{% else %}
			<button class="btn btn-success" disabled title="Agrega productos para poder finalizar">Finalizar</button>
			{% endif %}
		</div>
	</div>
</div>

{# Mensajes SweetAlert ahora se manejan globalmente en base_encargado.html #}

{% endblock %}
