{% extends 'base_encargado.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Reporte de viajes</h2>
    <div class="d-flex gap-2"></div>
  </div>

  <form method="get" class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Chofer</label>
          <select class="form-select" name="chofer">
            <option value="">Todos</option>
            {% for e in choferes %}
              <option value="{{ e.id }}" {% if e.id == chofer_sel %}selected{% endif %}>{{ e }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Camión</label>
          <select class="form-select" name="camion">
            <option value="">Todos</option>
            {% for c in camiones %}
              <option value="{{ c.id }}" {% if c.id == camion_sel %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" name="fecha" value="{{ fecha_sel }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Desde</label>
          <input type="date" class="form-control" name="desde" value="{{ desde }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Hasta</label>
          <input type="date" class="form-control" name="hasta" value="{{ hasta }}">
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button class="btn btn-primary flex-grow-1" type="submit">Aplicar filtros</button>
          <a class="btn btn-outline-secondary" href="?">Limpiar</a>
        </div>
      </div>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="tablaViajes">
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>Chofer</th>
          <th>Ayudante</th>
          <th>Camión</th>
          <th>Activos</th>
          <th>Entregados</th>
          <th>Total pedidos</th>
        </tr>
      </thead>
      <tbody>
        {% for v in viajes %}
        <tr>
          <td>{{ v.viaje.id }}</td>
          <td>{{ v.viaje.fecha|date:"d/m/Y H:i" }}</td>
          <td>{{ v.viaje.chofer }}</td>
          <td>{{ v.viaje.ayudante }}</td>
          <td>{{ v.viaje.camion_viaje }}</td>
          <td>{{ v.activos }}</td>
          <td>{{ v.entregados }}</td>
          <td>{{ v.total_pedidos }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center py-3">Sin resultados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">Pedidos por fecha de viaje</h5>
      <div id="viajesChart" style="height:300px;"></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  (function(){
    const labels = [
      {% for v in viajes %}"{{ v.viaje.fecha|date:'d/m/Y' }}"{% if not forloop.last %}, {% endif %}{% endfor %}
    ];
    const data = [
      {% for v in viajes %}{{ v.total_pedidos }}{% if not forloop.last %}, {% endif %}{% endfor %}
    ];
    const el = document.getElementById('viajesChart');
    if (el && labels.length) {
      const chart = echarts.init(el);
      chart.setOption({
        tooltip: {},
        xAxis: { type: 'category', data: labels },
        yAxis: { type: 'value', name: 'Pedidos' },
        series: [{ type: 'bar', data, itemStyle: { color: '#198754' } }]
      });
    }
  })();
</script>
{% endblock %}
