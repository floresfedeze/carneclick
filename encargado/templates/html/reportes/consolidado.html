{% extends "base_encargado.html" %}
{% load static %}

{% block head %}
<title>Reporte consolidado</title>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Reporte consolidado</h2>
      <small class="text-muted">Filtros por fecha, estado, corte y comercio</small>
    </div>
    <div class="d-flex gap-2"></div>
  </div>

  <form method="get" class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Estado</label>
          <select name="estado" class="form-select">
            <option value="">Todos</option>
            <option value="preparado" {% if estado_sel == 'preparado' %}selected{% endif %}>Preparado</option>
            <option value="activo" {% if estado_sel == 'activo' %}selected{% endif %}>Activo</option>
            <option value="entregado" {% if estado_sel == 'entregado' %}selected{% endif %}>Entregado</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Corte</label>
          <select name="corte" class="form-select">
            <option value="">Todos</option>
            {% for c in cortes %}
              <option value="{{ c.id }}" {% if corte_sel == c.id %}selected{% endif %}>{{ c.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Comercio</label>
          <select name="comercio" class="form-select">
            <option value="">Todos</option>
            {% for co in comercios %}
              <option value="{{ co.id }}" {% if comercio_sel == co.id %}selected{% endif %}>{{ co.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Desde</label>
          <input type="date" name="desde" class="form-control" value="{{ desde }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Hasta</label>
          <input type="date" name="hasta" class="form-control" value="{{ hasta }}">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Aplicar filtros</button>
        <a class="btn btn-outline-secondary" href="?">Limpiar</a>
      </div>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Total pedidos</div><div class="display-6">{{ total_pedidos }}</div></div></div></div>
    <div class="col-md-9">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted mb-2">Pedidos por estado</div>
          <div class="d-flex gap-3 flex-wrap">
            {% for e in por_estado %}
              <span class="badge bg-secondary">{{ e.estado__estado|capfirst }}: {{ e.cant }}</span>
            {% empty %}
              <span class="text-muted">Sin datos</span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">Top cortes por kg</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead><tr><th>Corte</th><th>Kilos</th><th>Items</th><th>Acciones</th></tr></thead>
          <tbody>
            {% for t in top_cortes %}
              <tr>
                <td>{{ t.producto_id__nombre__nombre }}</td>
                <td>{{ t.kg|floatformat:2 }} kg</td>
                <td>{{ t.cant }}</td>
                <td>
                  {% if t.producto_id %}
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'encargado:ver_producto' t.producto_id %}">Ver</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center py-3">Sin datos</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
