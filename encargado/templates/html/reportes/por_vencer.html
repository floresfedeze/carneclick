{% extends 'base_encargado.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Productos por vencer</h2>
     <div class="d-flex gap-2"></div>
  </div>

  <form method="get" class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Días hacia adelante</label>
          <input type="number" class="form-control" name="dias" min="1" value="{{ dias }}">
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button class="btn btn-primary flex-grow-1" type="submit">Aplicar filtros</button>
          <a class="btn btn-outline-secondary" href="?">Limpiar</a>
        </div>
      </div>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="tablaVencer">
      <thead>
        <tr>
          <th>#</th>
          <th>Corte</th>
          <th>Frigorífico</th>
          <th>Fecha entrada</th>
          <th>Vence</th>
          <th>Restante</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.prod.id }}</td>
          <td>{{ it.prod.nombre.nombre }}</td>
          <td>{{ it.prod.frigorificop.nombre }}</td>
          <td>{{ it.prod.fecha_entrada.fecha|date:"d/m/Y" }}</td>
          <td>{{ it.venc|date:"d/m/Y" }}</td>
          <td>{{ it.venc|timeuntil }}</td>
          <td>
            {% if it.prod.estado == 'en stock' %}
              <span class="badge bg-info text-dark">En stock</span>
            {% elif it.prod.estado == 'preparado' %}
              <span class="badge bg-primary">Preparado</span>
            {% elif it.prod.estado == 'de viaje' %}
              <span class="badge bg-warning text-dark">De viaje</span>
            {% elif it.prod.estado == 'entregado' %}
              <span class="badge bg-success">Entregado</span>
            {% else %}
              {{ it.prod.estado|capfirst }}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center py-3">Sin productos próximos a vencer</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">Cantidad por fecha de vencimiento</h5>
      <div id="vencerChart" style="height:300px;"></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  (function(){
    const rows = document.querySelectorAll('#tablaVencer tbody tr');
    const map = new Map();
    rows.forEach(tr => {
      const fecha = tr.children[4]?.textContent?.trim();
      if (!fecha) return;
      map.set(fecha, (map.get(fecha) || 0) + 1);
    });
    const labels = Array.from(map.keys());
    const data = Array.from(map.values());
    const el = document.getElementById('vencerChart');
    if (el && labels.length) {
      const chart = echarts.init(el);
      chart.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: labels },
        yAxis: { type: 'value', name: 'Cantidad' },
        series: [{ type: 'line', smooth: true, data, lineStyle: { color: '#dc3545' }, areaStyle: { color: 'rgba(220,53,69,0.2)' } }]
      });
    }
  })();
</script>
{% endblock %}
